import React,{Component} from 'react';import {    Dimensions,    View,    Text,    StyleSheet,    ScrollView,    TouchableOpacity,    Image,    DeviceEventEmitter,    Alert,    TextInput} from 'react-native'import {connect} from 'react-redux'import {Toolbar,OPTION_SHOW,OPTION_NEVER,ACTION_ADD} from 'react-native-toolbar-wrapper';import Config from '../../../config';import Proxy from '../../utils/Proxy';import Video from 'react-native-video'import Icon from 'react-native-vector-icons/FontAwesome';import Ionicons from 'react-native-vector-icons/Ionicons';import ActionSheet from 'react-native-actionsheet';import {fetchNewsInfo} from '../../action/NewsActions'var {height,width} = Dimensions.get('window');var ImagePicker = require('react-native-image-picker');class AddNews extends Component{    constructor(props){        super(props);        this.state={            isRefreshing:false,            news:{title:null,brief:null,photourl:null,authorId:this.props.personInfo.personId,type:null,typeStr:null},            newsTypeButtons:['取消','一般新闻','比赛新闻']        };    }    goBack(){        const { navigator } = this.props;        if(navigator) {            navigator.pop();        }    }    _handlePress(index) {        if(index!==0){            var newsTypeStr = this.state.newsTypeButtons[index];            var newsType = index;            this.setState({news:Object.assign(this.state.news,{type:parseInt(newsType).toString(),typeStr:newsTypeStr})});        }    }    show(actionSheet) {        this[actionSheet].show();    }    showImagePicker(){        var options = {            storageOptions: {                skipBackup: true,                path: 'images'            },            title:'请选择',            takePhotoButtonTitle:'拍照',            chooseFromLibraryButtonTitle:'图库',            cancelButtonTitle:'取消',        };        ImagePicker.showImagePicker(options, (response) => {            if (response.didCancel) {                console.log('User cancelled image picker');            }            else if (response.error) {                console.log('ImagePicker Error: ', response.error);            }            else if (response.customButton) {                console.log('User tapped custom button: ', response.customButton);            }            else {                let uri = { uri: response.uri };                let path = { uri: response.path };                this.setState({course:Object.assign(this.state.news,{photourl:uri})});                console.log('portrait.uri = ', response.uri);            }        });    }    render(){        const CANCEL_INDEX = 0;        const DESTRUCTIVE_INDEX = 1;        return(            <View style={styles.container}>                <Toolbar width={width} title="发布新闻" actions={[]} navigator={this.props.navigator}>                    <View style={{flexDirection:'column',justifyContent:'center',alignItems:'center'}}>                        {/*新闻标题*/}                        <View style={{height:40,width:width,flexDirection:'row',justifyContent:'flex-end',alignItems: 'center',backgroundColor:'#fff',marginBottom:1,paddingHorizontal:10}}>                            <View style={{flex:1}}>                                <Text style={{color:'#343434'}}>新闻标题</Text>                            </View>                            <View style={{flex:3,flexDirection:'row',justifyContent:'flex-end',alignItems: 'center',backgroundColor:'#fff',}}>                                <TextInput                                    placeholderTextColor='#888'                                    style={{fontSize:14,color:'#222',justifyContent:'flex-end',textAlign:'right',height:40,flex:3,padding:0}}                                    placeholder="请输入新闻标题"                                    value={this.state.news.title}                                    underlineColorAndroid={'transparent'}                                    onChangeText={                                        (value)=>{                                            this.setState({news:Object.assign(this.state.news,{title:value})})                                        }}                                />                            </View>                        </View>                        {/*新闻类型*/}                        <View style={{height:40,width:width,flexDirection:'row',justifyContent:'center',alignItems: 'center',backgroundColor:'#fff',marginBottom:1,paddingHorizontal:10}}>                            <View style={{flex:1}}>                                <Text style={{color:'#343434'}}>新闻类型</Text>                            </View>                            <TouchableOpacity style={{flex:3,flexDirection:'row',justifyContent:'center',alignItems: 'center',backgroundColor:'#fff'}}                                              onPress={()=>{ this.show('actionSheet'); }}>                                {                                    this.state.news.typeStr==null?                                        <View style={{flex:1,paddingRight:8,justifyContent:'flex-end',alignItems: 'center',flexDirection:'row'}}>                                            <Text style={{color:'#888',fontSize:14}}>请选择新闻类型 ></Text>                                        </View> :                                        <View style={{flex:1,marginLeft:20,justifyContent:'flex-end',alignItems: 'center',flexDirection:'row'}}>                                            <Text style={{color:'#444',fontSize:14}}>{this.state.news.typeStr}</Text>                                        </View>                                }                                <ActionSheet                                    ref={(p) => {                                        this.actionSheet =p;                                    }}                                    title="请选择新闻类型"                                    options={this.state.newsTypeButtons}                                    cancelButtonIndex={CANCEL_INDEX}                                    destructiveButtonIndex={DESTRUCTIVE_INDEX}                                    onPress={                                        (data)=>{ this._handlePress(data); }                                    }                                />                            </TouchableOpacity>                        </View>                        {/*新闻内容*/}                        <View style={{height:120,width:width,flexDirection:'column',justifyContent:'flex-start',alignItems: 'center',backgroundColor:'#fff',marginBottom:1,paddingHorizontal:10}}>                            <View style={{width:width,height:40,justifyContent:'center',textAlign:'left',paddingHorizontal:10}}>                                <Text style={{color:'#343434'}}>新闻内容</Text>                            </View>                            <TextInput                                style={{flex:2,fontSize:14,marginTop:5,backgroundColor:'#fff',padding:0}}                                onChangeText={(text) =>                                {                                    this.setState({news:Object.assign(this.state.news,{brief:text})});                                }}                                value={this.state.news.brief}                                placeholder='请描述新闻内容'                                placeholderTextColor="#888"                                underlineColorAndroid={'transparent'}                                multiline={true}                            />                        </View>                    </View>                    {/*添加图片*/}                    <View style={{flex:2,flexDirection:'column'}}>                        <View style={{flexDirection:'row',alignItems:'center',backgroundColor:'#fff',marginBottom:1}}>                            <View style={{width:width,height:40,justifyContent:'center',textAlign:'left',paddingHorizontal:10}}>                                <Text style={{color:'#343434'}}>新闻图片</Text>                            </View>                        </View>                        {                            this.state.news.photourl !== null?                                <View style={{flex:1,padding:10,justifyContent:'center',alignItems:'center',backgroundColor:'#fff'}}>                                    <Image                                        style={styles.backgroundVideo}                                        source={{uri:this.state.news.photourl.uri}}                                    />                                </View>                                :                                <View style={{flex:1,padding:10,justifyContent:'center',alignItems:'center',backgroundColor:'#fff'}}>                                    <Ionicons name='md-images' size={80} color="#aaa"/>                                </View>                        }                    </View>                    <View style={{flexDirection:'row',justifyContent:'center',alignItems:'center',width:width,marginBottom:10}}>                        <TouchableOpacity style={{flex:1,backgroundColor:'#fc6254',padding:10,flexDirection:'row',                            justifyContent:'center'}}                                          onPress={()=>{                                              this.showImagePicker()                                          }}>                            <Text style={{color:'#fff',fontSize:15}}>上传图片</Text>                        </TouchableOpacity>                        <TouchableOpacity style={{flex:1,backgroundColor:'#fca482',padding:10,flexDirection:'row',                            justifyContent:'center'}}                                          onPress={()=>{                                              Proxy.postes({                                                  url: Config.server + '/func/allow/addNewsInformation',                                                  headers: {                                                      'Content-Type': 'application/json',                                                  },                                                  body: {                                                      news:this.state.news                                                  }                                              }).then((json) => {                                                  var attachId = json.data;                                                  var formData = new FormData();                                                  var file = {uri: this.state.news.photourl.uri, type: 'multipart/form-data', name: 'img.jpg'};                                                  formData.append('photo',file)                                                  Proxy.post({                                                      url:Config.server+'/func/allow/uploadNewsPic?attachId='+attachId.toString(),                                                      headers: {                                                          'Content-Type':'multipart/form-data',                                                      },                                                      body: formData,                                                  }).then((json)=> {                                                      var data = json.data;                                                      if(data == 'success'){                                                          alert("添加新闻成功！")                                                          this.goBack();                                                      }                                                      resolve(json)                                                  }).catch((err) =>{                                                      //reject(err)                                                  })                                              }).catch((err) => {                                                  alert(err);                                              });                                          }}>                            <Text style={{color:'#fff',fontSize:15}}>发布</Text>                        </TouchableOpacity>                    </View>                </Toolbar>            </View>        )    }    componentWillUnmount(){    }}const styles = StyleSheet.create({    container:{        flex:1,backgroundColor:'#eee'    },    backgroundVideo: {        position: 'absolute',        top: 0,        left: 0,        bottom: 0,        right: 0,    },})module.exports = connect(state=>({        accessToken:state.user.accessToken,        personInfo:state.user.personInfo,    }))(AddNews);