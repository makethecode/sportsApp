import React,{Component} from 'react';import {    Dimensions,    View,    Text,    StyleSheet,    ScrollView,    TouchableOpacity,    Image,    DeviceEventEmitter,    Alert,    TextInput} from 'react-native'import {connect} from 'react-redux'import {Toolbar,OPTION_SHOW,OPTION_NEVER,ACTION_ADD} from 'react-native-toolbar-wrapper';import Config from '../../../config';import Proxy from '../../utils/Proxy';import Video from 'react-native-video'import Icon from 'react-native-vector-icons/FontAwesome';import Ionicons from 'react-native-vector-icons/Ionicons';import ActionSheet from 'react-native-actionsheet';import {getAccessToken} from "../../action/UserActions";import {saveOrUpdateBadmintonCourseClassRecords} from "../../action/CourseActions";var {height,width} = Dimensions.get('window');var ImagePicker = require('react-native-image-picker');class AddVideo extends Component{    constructor(props){        super(props);        this.state={            isRefreshing:false,            video:{name:null,brief:null,longbrief:null,videourl:null,videopath:null,authorId:this.props.personInfo.personId,type:null,typeStr:null},            videoTypeButtons:['取消','视频','音频']        };    }    goBack(){        const { navigator } = this.props;        if(navigator) {            navigator.pop();        }    }    _handlePress(index) {        if(index!==0){            var videoTypeStr = this.state.videoTypeButtons[index];            var videoType = index;            this.setState({video:Object.assign(this.state.video,{type:parseInt(videoType),typeStr:videoTypeStr})});        }    }    show(actionSheet) {        this[actionSheet].show();    }    showImagePicker(){        var options = {            storageOptions: {                skipBackup: true,                path: 'video'            },            title:'请选择',            takePhotoButtonTitle:'拍摄',            chooseFromLibraryButtonTitle:'视频库',            cancelButtonTitle:'取消',            mediaType:'video'        };        ImagePicker.showImagePicker(options, (response) => {            if (response.didCancel) {                console.log('User cancelled image picker');            }            else if (response.error) {                console.log('ImagePicker Error: ', response.error);            }            else if (response.customButton) {                console.log('User tapped custom button: ', response.customButton);            }            else {                let uri = { uri: response.uri };                let path = { uri: response.path };                this.setState({course:Object.assign(this.state.video,{videourl:uri,videopath:path})});                console.log('portrait.uri = ', response.uri);            }        });    }    render(){        // video:{name:null,brief:null,longbrief:null,videourl:null,videopath:null,authorId:this.props.personInfo.personId,type:null,typeStr:null},        const CANCEL_INDEX = 0;        const DESTRUCTIVE_INDEX = 1;        return(            <View style={styles.container}>                <Toolbar width={width} title="视频发布" actions={[]} navigator={this.props.navigator}>                    <View style={{flexDirection:'column',justifyContent:'center',alignItems:'center'}}>                        {/*视频标题*/}                        <View style={{height:40,width:width,flexDirection:'row',justifyContent:'flex-end',alignItems: 'center',backgroundColor:'#fff',marginBottom:1,paddingHorizontal:10}}>                            <View style={{flex:1}}>                                <Text style={{color:'#343434'}}>视频标题</Text>                            </View>                            <View style={{flex:3,flexDirection:'row',justifyContent:'flex-end',alignItems: 'center',backgroundColor:'#fff',}}>                                <TextInput                                    placeholderTextColor='#888'                                    style={{fontSize:14,color:'#222',justifyContent:'flex-end',textAlign:'right',height:40,flex:3,padding:0}}                                    placeholder="请输入视频标题"                                    value={this.state.video.name}                                    underlineColorAndroid={'transparent'}                                    onChangeText={                                        (value)=>{                                            this.setState({video:Object.assign(this.state.video,{name:value})})                                        }}                                />                            </View>                        </View>                        {/*视频类型*/}                        <View style={{height:40,width:width,flexDirection:'row',justifyContent:'center',alignItems: 'center',backgroundColor:'#fff',marginBottom:1,paddingHorizontal:10}}>                            <View style={{flex:1}}>                                <Text style={{color:'#343434'}}>视频类型</Text>                            </View>                            <TouchableOpacity style={{flex:3,flexDirection:'row',justifyContent:'center',alignItems: 'center',backgroundColor:'#fff'}}                                              onPress={()=>{ this.show('actionSheet'); }}>                                {                                    this.state.video.typeStr==null?                                        <View style={{flex:1,paddingRight:8,justifyContent:'flex-end',alignItems: 'center',flexDirection:'row'}}>                                            <Text style={{color:'#888',fontSize:14}}>请选择视频类型 ></Text>                                        </View> :                                        <View style={{flex:1,marginLeft:20,justifyContent:'flex-end',alignItems: 'center',flexDirection:'row'}}>                                            <Text style={{color:'#444',fontSize:14}}>{this.state.video.typeStr}</Text>                                        </View>                                }                                <ActionSheet                                    ref={(p) => {                                        this.actionSheet =p;                                    }}                                    title="请选择视频类型"                                    options={this.state.videoTypeButtons}                                    cancelButtonIndex={CANCEL_INDEX}                                    destructiveButtonIndex={DESTRUCTIVE_INDEX}                                    onPress={                                        (data)=>{ this._handlePress(data); }                                    }                                />                            </TouchableOpacity>                        </View>                        {/*视频简介*/}                        <View style={{height:40,width:width,flexDirection:'row',justifyContent:'flex-end',alignItems: 'center',backgroundColor:'#fff',marginBottom:1,paddingHorizontal:10}}>                            <View style={{flex:1}}>                                <Text style={{color:'#343434'}}>视频简介</Text>                            </View>                            <View style={{flex:3,flexDirection:'row',justifyContent:'flex-end',alignItems: 'center',backgroundColor:'#fff',}}>                                <TextInput                                    placeholderTextColor='#888'                                    style={{fontSize:14,color:'#222',justifyContent:'flex-end',textAlign:'right',height:40,flex:3,padding:0}}                                    placeholder="请输入视频简介"                                    value={this.state.video.brief}                                    underlineColorAndroid={'transparent'}                                    onChangeText={                                        (value)=>{                                            this.setState({video:Object.assign(this.state.video,{brief:value})})                                        }}                                />                            </View>                        </View>                        {/*视频描述*/}                        <View style={{height:120,width:width,flexDirection:'column',justifyContent:'flex-start',alignItems: 'center',backgroundColor:'#fff',                            marginBottom:1,paddingHorizontal:10,textAlign:'left',textAlign:'left',}}>                            <View style={{width:width,height:40,justifyContent:'center',paddingHorizontal:10}}>                                <Text style={{color:'#343434'}}>视频描述</Text>                            </View>                            <TextInput                                style={{width:width,height:120,fontSize:14,backgroundColor:'#fff',paddingHorizontal:10}}                                onChangeText={(text) =>                                {                                    this.setState({video:Object.assign(this.state.video,{longbrief:text})});                                }}                                value={this.state.video.longbrief}                                placeholder='请描述视频内容'                                placeholderTextColor="#888"                                underlineColorAndroid={'transparent'}                                multiline={true}                            />                        </View>                    </View>                    {/*添加视频*/}                    <View style={{flex:2,flexDirection:'column'}}>                        <View style={{flexDirection:'row',alignItems:'center',backgroundColor:'#fff',marginBottom:1}}>                            <View style={{width:width,height:40,justifyContent:'center',textAlign:'left',paddingHorizontal:10}}>                                <Text style={{color:'#343434'}}>上传视频</Text>                            </View>                        </View>                        {                            this.state.video.videourl !== null?                                <View style={{flex:1,padding:10,justifyContent:'center',alignItems:'center',backgroundColor:'#fff'}}>                                    <Video                                        source={{uri: this.state.video.videourl.uri}} // Can be a URL or a local file.                                        rate={1.0}                   // 控制暂停/播放，0 代表暂停                                        volume={1.0}                 // 声音的放大倍数，0 代表没有声音，就是静音muted, 1 代表正常音量 normal，更大的数字表示放大的倍数                                        muted={false}                //true代表静音，默认为false.                                        paused={true}               // Pauses playback entirely.                                        resizeMode="cover"           // 视频的自适应伸缩铺放行为，                                        repeat={true}                // 是否重复播放                                        style={styles.backgroundVideo}                                    />                                </View>                                :                                <View style={{flex:1,padding:10,justifyContent:'center',alignItems:'center',backgroundColor:'#fff'}}>                                    <Ionicons name='md-videocam' size={80} color="#aaa"/>                                </View>                        }                    </View>                    <View style={{flexDirection:'row',justifyContent:'center',alignItems:'center',width:width,marginBottom:10}}>                        <TouchableOpacity style={{flex:1,backgroundColor:'#fc6254',padding:10,flexDirection:'row',                            justifyContent:'center'}}                                          onPress={()=>{                                              this.showImagePicker()                                          }}>                            <Text style={{color:'#fff',fontSize:15}}>上传视频</Text>                        </TouchableOpacity>                        <TouchableOpacity style={{flex:1,backgroundColor:'#fca482',padding:10,flexDirection:'row',                            justifyContent:'center'}}                                          onPress={()=>{                                              Proxy.postes({                                                  url: Config.server + '/func/allow/addVideoInformation',                                                  headers: {                                                      'Content-Type': 'application/json',                                                  },                                                  body: {                                                      video:this.state.video                                                  }                                              }).then((json) => {                                                  var attachId = json.data;                                                  var formData = new FormData();                                                  var file = {uri: this.state.video.videourl.uri, type: 'multipart/form-data', name: 'video.mp4'};                                                  formData.append('video',file)                                                  Proxy.post({                                                      url:Config.server+'/func/allow/uploadVideos?attachId='+attachId.toString(),                                                      headers: {                                                          'Content-Type':'multipart/form-data',                                                      },                                                      body: formData,                                                  }).then((json)=> {                                                      var data = json.data;                                                      if(data == 'success'){                                                          Alert.alert('成功','添加视频成功')                                                          this.goBack();                                                      }                                                      resolve(json)                                                  }).catch((err) =>{                                                      //reject(err)                                                  })                                              }).catch((err) => {                                                  alert(err);                                              });                                          }}>                            <Text style={{color:'#fff',fontSize:15}}>发布视频</Text>                        </TouchableOpacity>                    </View>                </Toolbar>            </View>        )    }}const styles = StyleSheet.create({    container:{        flex:1,backgroundColor:'#eee'    },    backgroundVideo: {        position: 'absolute',        top: 0,        left: 0,        bottom: 0,        right: 0,    },})module.exports = connect(state=>({        accessToken:state.user.accessToken,        personInfo:state.user.personInfo,    }))(AddVideo);